# API リファレンス 📚

このドキュメントは、CryptoPay Rust SDKのすべてのAPIインターフェースの詳細を説明します。リクエストパラメータ、戻りパラメータ、および例を含みます。

## 新規ユーザーの登録 (create_user)🆕🧑‍💻

### コンセプト
新しいプラットフォームユーザーを作成し、ユーザーの一意のID、つまりUserOpenIdが必要です。

### HTTP リクエスト
- インターフェース名: create_user
- URL: https://sandbox-api.privatex.io/sdk/user/create
- メソッド: POST

### リクエストパラメータ
| パラメータ名 | 必須 | タイプ | 説明                                                                      |
| ------------ | ---- | ------ | ------------------------------------------------------------------------- |
| OpenId       | はい | string | プラットフォーム標準プレフィックス + ユーザー一意IDを推奨してOpenIdを形成 |

### 戻りパラメータ
| パラメータ名 | タイプ | 説明                       |
| ------------ | ------ | -------------------------- |
| code         | int    | グローバルステータスコード |
| msg          | string | ステータス説明             |
| data.OpenId  | string | ユーザー一意のOpenId       |
| sign         | string | プラットフォーム署名       |

### 例
リクエスト例:
```bash
curl --location 'https://sandbox-api.privatex.io/sdk/user/create' \
--header 'key: vratson2i5hjxgkd' \
--header 'sign: 0592dc64d480fb119d1e07ce06011db8' \
--header 'clientSign: xxxxxxxxxxxxxxxxx' \
--header 'Content-Type: application/json' \
--header 'timestamp: 1725076567682' \
--data '{ 
  "OpenId":"PT00001"
}'
```
戻り例:
```json
{
    "code": 1,
    "msg": "ok",
    "data": {
        "OpenId": "PT00001"
    },
    "sign": "..."
}
```

認証とセキュリティについては、[🧩 authentication.md](./authentication.md)を参照してください

## ウォレットの作成 (create_wallet) 💰

### コンセプト
対応するブロックチェーンネットワークでユーザーのウォレットアカウントを作成します。

### HTTP リクエスト
- インターフェース名: create_wallet
- URL: https://sandbox-api.privatex.io/sdk/wallet/create
- メソッド: POST

### リクエストパラメータ
| パラメータ名 | 必須 | タイプ | 説明                 |
| ------------ | ---- | ------ | -------------------- |
| ChainID      | はい | string | チェーンID           |
| OpenId       | はい | string | ユーザー一意のOpenId |

### 戻りパラメータ
| パラメータ名 | タイプ | 説明                       |
| ------------ | ------ | -------------------------- |
| code         | int    | グローバルステータスコード |
| msg          | string | ステータス説明             |
| data.address | string | ウォレットアドレス         |
| data.OpenId  | string | ユーザー一意のOpenId       |
| sign         | string | プラットフォーム署名       |

### 例
リクエスト例:
```bash
curl --location 'https://sandbox-api.privatex.io/sdk/wallet/create' \
--header 'key: vratson2i5hjxgkd' \
--header 'sign: 0592dc64d480fb119d1e07ce06011db8' \
--header 'clientSign: xxxxxxxxxxxxxxxxx' \
--header 'Content-Type: application/json' \
--header 'timestamp: 1725076567682' \
--data '{
  "OpenId":"PT00001",
  "ChainID":"1"
}'
```
戻り例:
```json
{
    "code": 1,
    "msg": "ok",
    "data": {
        "address": "...",
        "OpenId": "PT00001"
    },
    "sign": "..."
}
```

## 入金アドレスの取得 (get_wallet_addresses)💳

### コンセプト
ユーザーのブロックチェーンウォレットの入金アドレスを取得します。

### HTTP リクエスト
- インターフェース名: get_wallet_addresses
- URL: https://sandbox-api.privatex.io/sdk/wallet/getWalletAddresses
- メソッド: POST

### リクエストパラメータ
| パラメータ名 | 必須 | タイプ | 説明                           |
| ------------ | ---- | ------ | ------------------------------ |
| OpenId       | はい | string | ユーザー一意のOpenId           |
| ChainIDs     | はい | string | 複数のチェーンID、カンマ区切り |

### 戻りパラメータ
| パラメータ名   | タイプ | 説明                       |
| -------------- | ------ | -------------------------- |
| code           | int    | グローバルステータスコード |
| msg            | string | ステータス説明             |
| data.Addresses | array  | アドレスリスト             |
| sign           | string | プラットフォーム署名       |

### 例
リクエスト例:
```bash
curl --location 'https://sandbox-api.privatex.io/sdk/wallet/getWalletAddresses' \
--header 'key: vratson2i5hjxgkd' \
--header 'sign: 0592dc64d480fb119d1e07ce06011db8' \
--header 'clientSign: xxxxxxxxxxxxxxxxx' \
--header 'Content-Type: application/json' \
--header 'timestamp: 1725076567682' \
--data '{
  "OpenId":"PT00001",
  "ChainIDs":"56,2"
}'
```
戻り例:
```json
{
    "code": 1,
    "msg": "ok",
    "data": {
        "Addresses": [
            {
                "chainID": 56,
                "address": "..."
            }
        ]
    },
    "sign": "..."
}
```

## ユーザー出金 (user_withdraw_by_open_id)💸

### コンセプト
ユーザー出金操作、パートナーアカウントからユーザー指定アドレスへの転送。

* 機能: ユーザー出金操作インターフェース。出金は対応するトークン出金プールのパートナーアカウントからユーザーの指定出金ウォレットアドレスに転送する必要があります。パートナーはセキュアコールバックアドレスを設定して出金の正当性を検証できます。検証が有効であれば、マーチャントの資金プールウォレットから直接出金を完了できます。

* 出金トランザクションインターフェースは、デフォルトの出金ホットウォレットに十分な出金資産と手数料があるかをチェックします。

* デフォルトでは、出金インターフェースはセキュリティ検証コードを唯一のパラメータ要件として使用します。一般的に、ビジネスプラットフォームの一意の出金注文番号をセキュリティコードとして使用することを推奨します。重複するセキュリティ検証コードを提出するとエラーが発生します。

* すべての出金トランザクションリクエストは、チャネルプラットフォームで構成されたリスクコントロールレビュー規則に一致します。パラメータリクエストが有効であれば、トランザクションリクエストは受け入れられます。自動レビュー規則に一致する出金トランザクションは即座にネットワークトランザクションに提出され、提出されたトランザクションのハッシュ情報が返されます（戻りフィールドdata）。チャネルで二次レビューが必要な出金トランザクションリクエストは（code=2）を返します。出金リクエストを再提出する必要はありません。管理者が出金リクエストをチャネルプラットフォームで二次レビューを完了する必要があります。二次レビュー完了後、トランザクション注文はコールバックで出金トランザクションステータス変更を通知します。

* 前提: 対応する通貨の資金プールに十分な資金が出金可能であること（特にETHネットワークトークン出金の場合、資金プールウォレットに一定量のETHトランザクション手数料残高が必要です）。

* ⚠️ 注意: **ブロックチェーン出金の場合、インターフェースを呼び出す前に事前承認プロセスが完了していることを確認してください。ブロックチェーントランザクションが開始されたら、取り消しや返金はできません。**

### HTTP リクエスト
- インターフェース名: user_withdraw_by_open_id
- URL: https://sandbox-api.privatex.io/sdk/partner/UserWithdrawByOpenID
- メソッド: POST

### リクエストパラメータ
| パラメータ名  | 必須   | タイプ | 説明                   |
| ------------- | ------ | ------ | ---------------------- |
| OpenId        | はい   | string | ユーザー一意のOpenId   |
| TokenId       | はい   | string | トークンID             |
| Amount        | はい   | float  | 出金額                 |
| AddressTo     | はい   | string | 対象アドレス           |
| CallBackUrl   | いいえ | string | コールバックURL        |
| SafeCheckCode | いいえ | string | セキュリティ検証コード |

### 戻りパラメータ

| パラメータ名 | タイプ | 説明                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           |
| :----------- | :----- | :------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| code         | int    | ステータスコード</br>0 パラメータエラー、重複注文番号、不正な出金アドレス形式、または出金ウォレット手数料不足。詳細情報はmsgで確認できます。</br>1 出金トランザクションが正常に提出され、ブロックチェーンネットワークに提出されました。提出されたトランザクションの一意のハッシュはdataに含まれます。</br>2 出金トランザクションが正常に提出され、二次チャネルレビューが必要です。レビュー完了後、トランザクションは完了できます。</br>-1 出金トランザクションが失敗しました。出金リクエストを再提出できます。 |
| msg          | string | ステータス説明                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 |
| data         | string | トランザクションハッシュ。スマート出金が有効の場合、このフィールドは空文字列として返されます。                                                                                                                                                                                                                                                                                                                                                                                                                 |
| sign         | string | プラットフォーム署名                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           |
| timestamp    | string | 現在のタイムスタンプをミリ秒で文字列に変換                                                                                                                                                                                                                                                                                                                                                                                                                                                                     |


### 例
リクエスト例:
```bash
curl --location 'https://sandbox-api.privatex.io/sdk/partner/UserWithdrawByOpenID' \
--header 'key: vratson2i5hjxgkd' \
--header 'sign: 0592dc64d480fb119d1e07ce06011db8' \
--header 'clientSign: xxxxxxxxxxxxxxxxx' \
--header 'Content-Type: application/json' \
--header 'timestamp: 1725076567682' \
--data '{ 
  "OpenId": "PT00001", 
  "TokenId": "4", 
  "Amount": "0.02", 
  "AddressTo": "TQdL5yttJPTx7hJmBhGfo2LcE7AXLPtHSg", 
  "CallBackUrl": "http://xxxxxx/withdraw_callback", 
  "SafeCheckCode": "1000000000000000"
}'
```

戻り例
```json
{
    "sign": "D+VTPNiwGLzh9eIvkrscwS4UlGKzdnrBgB63RDG4HeobZT6FXqUwYCPgKojynKaxwm5PkmW0xhIASZ4asSCvnYfi0NSFehchZAtUnQIispxKcjsiudWsUznbkEIQ2h2TA/mbUZ1X9+wyh7QhNo6+RkxtgRyRpVb7ARG8pL14cdTAs OTtMLO0W1GO0M83VAv2ybBZNObncX9qy6tdwLQV/KYuNJYyMN0dL0nLKYHnj9Q4d3lEDM45AVJ0153/YIiIgcF BnOWhsQ9rVARcFeXeWd9KJ5OZpmxlxnhcJGcEUY2UDC4zKLZxtUet7CPAyehAMQ5plkpvRrR3Z6lA5zl6GQ==",
    "timestamp": "1725439986754",
    "data": "94f4c29eba73d53dcd3aa1b8cf90a98108d0acf82f38b97a4032dcdf7ff172e7",
    "msg": "ok",
    "code": 1
}
```

## 出金注文二次レビュー 💳

* 機能: マーチャント出金注文リスクコントロール二次レビューインターフェース
* ⚠️ 注意: **プラットフォームはマーチャントに別個のリスクコントロールRSA公開鍵を割り当てます（入金/出金コールバック通知公開鍵とは異なります）**
* トリガー時間: 管理者が出金コールバックURLパラメータをマーチャント側で構成した後（システム設定）、チャネルは各出金トランザクションリクエストに追加のリスクコントロールコールバック二次レビューを追加します。マーチャント側リスクコントロールURLが正しい検証パスコードを返す場合にのみ、トランザクションは有効に提出されます。
* 技術要件: マーチャント側技術実装と二次レビューコールバックインターフェースの構成が必要です。

#### HTTP リクエスト

プラットフォームはマーチャントに出金レビューリクエストを送信します

> POST: `/withdrawal/order/check`

#### リクエストパラメータ

| パラメータ名 | 必須   | タイプ | 説明                                                                                                                                      |
| :----------- | :----- | :----- | :---------------------------------------------------------------------------------------------------------------------------------------- |
| safeCode     | いいえ | string | マーチャントが提出した一意のトランザクションID、一般的にマーチャントの出金注文IDに対応（出金トランザクションのSafeCheckCode）             |
| openId       | はい   | string | 出金トランザクションを提出したマーチャントのユーザーID                                                                                    |
| tokenId      | はい   | string | 通貨ID、プラットフォームが提供する通貨IDに基づく                                                                                          |
| toAddress    | はい   | string | 出金アドレス                                                                                                                              |
| amount       | はい   | string | 出金額                                                                                                                                    |
| timestamp    | はい   | int    | 現在のタイムスタンプ                                                                                                                      |
| sign         | はい   | string | 署名: データフィールドのパラメータのみ署名; 署名の正しさをプラットフォームのリスクコントロールRSA公開鍵を使用して検証する必要があります。 |

#### 戻りパラメータの説明

| パラメータ名 | タイプ | 説明                                                                              |
| :----------- | :----- | :-------------------------------------------------------------------------------- |
| code         | int    | 検証結果。0はパスを示します; 他のコードは無効です。                               |
| timestamp    | int    | 現在のタイムスタンプ、秒単位。                                                    |
| message      | string | 戻りメッセージ。                                                                  |
| sign         | string | 署名: レスポンスパラメータのデータフィールドに対するマーチャントのRSA秘密鍵署名。 |

## 入金と出金のコールバック通知

1. 入金と出金トランザクションは複数のコールバック通知をトリガーします。最後のコールバック通知のトランザクション情報とステータスが使用されます。
2. ビジネス側は有効なコールバックメッセージを返す必要があります。形式は戻りパラメータの説明に記載されています。戻りコード0はコールバックメッセージが処理され、さらなる通知が必要ないことを示します。それ以外の場合、コールバックは通知を続けます（最初は2秒ごとに50回、その後10分ごとに）確認メッセージコード0が返されるまで。

サービスプロバイダーに連絡してコールバックURLを設定してください。

> POST

* 機能: プラットフォームがアプリケーション側にトークントランザクション情報（ユーザー出金または入金）を通知するためのコールバックメッセージ形式を定義します。このメッセージは、アプリケーション側のトークントランザクションステータス（出金または入金）に関するイベント通知に適しています。アプリケーションはアプリケーション機能に基づいてコールバック通知インターフェースをオプションでサポートできます。

### リクエストパラメータ

| パラメータ名 | 必須 | タイプ | 説明                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          |
| :----------- | :--- | :----- | :---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| openid       | はい | string | チャネルユーザー一意ID                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |
| totalvalue   | はい | string | 入金または出金トランザクションに対応するUSDT価値（トランザクション時の市場価格に基づいて計算）                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                |
| status       | はい | int    | トランザクションステータス:</br>1 トランザクションが完了し、ブロックチェーンネットワークに正常に提出されました。ハッシュを使用してチェーン上でトランザクションの詳細をクエリできます。</br>-1 トランザクションがブロックチェーンネットワークに提出されましたが、チェーントランザクションが失敗しました。マーチャント管理 --> トランザクション管理 --> [注文セキュリティコードの提出] で再レビューできます。ビジネスプラットフォームはステータス変更を処理する必要はなく、チャネルが新しいステータス通知をコールバックするのを待つだけです。</br>-2 出金トランザクション申請がマーチャントバックエンドによって拒否されました。出金申請は期限切れです。ビジネスプラットフォームは通知を受け取った後、ユーザーの出金申請を返すことを推奨します。</br>2 出金トランザクションがマーチャント管理に提出されました。構成された通貨セキュリティリスクコントロール要件をトリガーしたため、管理者はマーチャント管理 --> トランザクション管理 --> 出金レビューにログインして出金申請処理を完了する必要があります。</br>3 出金トランザクションのブロックチェーン処理中、ビジネスプラットフォームはステータス変更を更新する必要はなく、チャネルが新しいステータス通知を受け取るのを待つだけです。 </br>⛑️**特別なリマインダー: ビジネスプラットフォームが受け取った出金トランザクションコールバックで、status = -1の場合、コールバックを無視します。管理者が管理バックエンドにログインしてトランザクションを再提出した後、新しいステータス通知がプラットフォームに同時にプッシュされます。** |  | type | はい | int | 1は入金トランザクション; 2は出金トランザクション |
| hash         | はい | string | トランザクションハッシュ値                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |
| confirm      | はい | int    | トランザクションのチェーン上確認数                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            |
| createdtime  | はい | string | 作成時間                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      |
| from         | はい | string | トランザクション開始者のアドレス                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |
| to           | はい | string | トランザクション受信アドレス                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |
| amount       | はい | string | トランザクション金額                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          |
| chainid      | はい | string | チェーンID                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |
| tokenid      | はい | string | トークンID                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |
| tokenaddress | はい | string | トークン契約アドレス                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          |
| safecode     | はい | string | セキュリティコード                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            |
| timestamp    | はい | string | タイムスタンプ                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                |